<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Zypical provides you amazing online stores">
    <meta name="keywords" content="Zypical, Online Stores, Bazaar">
    <link rel="" href="../img/z-.png" type="image/x-"/>
    
    <title>Join Bazaar</title>
    <link rel="stylesheet" type="text/css" href="../style.css">
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <script src="../variable.js"></script>
</head>
<body class="container">
    

    <div class="form-style white">
        <div class="cluster">
            <img src="../img/zypical_black.png" class="logo">
            <br><br>
            <h2 class="heading">Join Virtual Bazaar</h2>   
            
            <div class="container-progress">
                <ul class="progressbar">
                    <li class="active">Activate Store</li>
                    <li >Profile Info</li>
                    <li>Upload Products</li>
                </ul>
            </div>
        </div>
    </div>

    
    <div class="form-style white">
        <div class="right">
            <a class="next">NEXT</a>
        </div> 
        <form id="myForm">
            <input hidden name="userID" value="5f042b7066e52800173b072a">

            Name <input type="text" required name="name" id="name">
            Username <input type="text" required name="handle" id="handle">
            Instagram username <input type="text" required name="instagram" id="handle">
            Facebook link <input type="text" required name="facebook" id="handle">
            
            Description <textarea type="textbox" required name="description" id="description" ></textarea>

            <div class="cluster">
                <input type="submit" id="submit" class="upload-button" value="Update" />
                <img src="../img/zypical-spinner.gif" class="loader" id="loader" style="height: 100px;" alt="">
                <img src="../img/check.png" style="height: 45px;" class="done"   id="done"  alt=""/>


            </div>
        </form> 
    </div>

<script>
    window.addEventListener( "load", function () {
        
        // user=5f042b7066e52800173b072a&&store=5eed10673f9e9f2720a84ec1
        const queryString = window.location.search;
        const urlParams = new URLSearchParams(queryString);
        const id = urlParams.get('id');

        const form = document.getElementById( "myForm" );
        form.addEventListener( "submit", function ( event ) {
            event.preventDefault();

            update();
        } );


        let xmlHttp = new XMLHttpRequest();
        xmlHttp.addEventListener( "load", function(event) {
            
            document.getElementById("loader").style.display = "none";
            const json = JSON.parse(event.target.response ).data;
            console.log(json);
            
            document.getElementById("name").value = json.name;
            document.getElementById("handle").value = json.handle;
            document.getElementById("description").value = json.description;
            document.getElementById("ig").value = json.socialLinks.instagram;
            document.getElementById("fb").value = json.socialLinks.facebook || "";
        })
        xmlHttp.open( "GET", `${api}/store/${id}`, false ); // false for synchronous request
        xmlHttp.send( null );




        function update() {
            console.log("Submitting data ");
            // document.getElementById(`loader`).style.display = "block";
            // document.getElementById(`submit`).style.display = "none";
            const XHR = new XMLHttpRequest();

            // Bind the FormData object and the form element
            const FD = new FormData( form );
            let object = {};

            FD.forEach((value, key) => {
                if(key === "transactionMethod"){
                    object["transactionMethod"].push(value)
                }
                else if(value === "") {
                    
                }
                else if(key === "ig" ) {
                    object.socialLinks.instagram = value;
                }
                else if(key === "fb" ) {
                    object.socialLinks.facebook = value;
                }
                else {
                    object[key] = value;
                }
            });

            // Define what happens on successful data submission
            XHR.addEventListener( "load", function(event) {
                document.getElementById(`loader`).style.display = "none";
                document.getElementById(`done`).style.display = "block";
                
            
            } );

            // Define what happens in case of error
            XHR.addEventListener( "error", function( event ) {
            alert( 'Oops! Something went wrong.' );
                document.getElementById(`loader`).style.display = "none";
                document.getElementById(`submit`).style.display = "block";
                console.log(event);
            
            } );

            // Set up our request
            XHR.open( "POST", `${api}/store/activate` );
            XHR.setRequestHeader("Content-Type", "application/json;charset=UTF-8");


            // The data sent is what the user provided in the form        
            
             
            console.log(JSON.stringify(object));
            
            XHR.send( json );

        }
        
    } );
    
</script>

</body>